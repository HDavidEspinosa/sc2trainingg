---

title: The `ingest` Module


keywords: fastai
sidebar: home_sidebar

summary: "This module contains the tools needed to extract game-play data from a set of StarCraft II replays. This process entails extracting various features that describe each players' performance during a 1v1 online match and organising all the information in a set of collections that compose a MongoDB database."
description: "This module contains the tools needed to extract game-play data from a set of StarCraft II replays. This process entails extracting various features that describe each players' performance during a 1v1 online match and organising all the information in a set of collections that compose a MongoDB database."
nb_path: "02_ingest.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 02_ingest.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>ingest</code> uses three modules to carry on its principal functions.</p>
<ol>
<li>It uses <a href="https://www.mongodb.com/">MongoDB</a> and <a href="https://pymongo.readthedocs.io/en/stable/">pymongo</a> to configure a document-based database where it stores the information of the replays. </li>
<li>It uses <a href="https://github.com/miguelgondu/sc2reaper">sc2reaper (Gonzalez Duque &amp; Arbelaez Echeverri, 2019)</a> to extract and load various default collections of information to the database (i.e. actions, players, replays, scores, and states). </li>
<li>It uses <a href="https://pypi.org/project/sc2reader/#history">sc2reader (Leung, 2020)</a> to extract information about the players' username so that the replays can be grouped by players later. In this case, <code>ingest</code> stores this extra information in an additional collection (i.e. replays_info) which extends the database where the previous collections exist. </li>
</ol>
<p>This module organises the gameplay data into the following collections:</p>
<ul>
<li>actions</li>
<li>players</li>
<li>replays = summary of the replays that have been processed.</li>
<li>states</li>
<li>scores</li>
<li>replays_info = summary of the replays that have been processed that includes usernames.</li>
</ul>
<p>This database is built using two functions defined in this module; <a href="/sc2trainingg/ingest.html#build_replay_info"><code>build_replay_info</code></a> and <a href="/sc2trainingg/ingest.html#build_reaper_collections"><code>build_reaper_collections</code></a> (see below).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Requirements-for-Proper-Functioning">Requirements for Proper Functioning<a class="anchor-link" href="#Requirements-for-Proper-Functioning"> </a></h2><p>Before anything else, this module looks for the local <code>config.json</code> file and loads its information into a <a href="/sc2trainingg/load_config.html#Config_settings"><code>Config_settings</code></a> object using the <a href="/sc2trainingg/load_config.html#load_configurations"><code>load_configurations</code></a> function from the <code>load_config</code> module.</p>
<p>With this information at hand, the module configures the MongoDB client it needs to store the replay data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Definition of the initial data needed to function</span>
<span class="n">CONFIG_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/Users/david/Documents/phdcode/sc2trainingg&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="n">load_configurations</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">)</span>

<span class="c1"># Define the client and data base to work with MongoDB</span>
<span class="n">DB_Client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">port_address</span><span class="p">,</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">port_number</span><span class="p">)</span>
<span class="n">DB</span> <span class="o">=</span> <span class="n">DB_Client</span><span class="p">[</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">db_name</span><span class="p">]</span>
<span class="n">replays_info</span> <span class="o">=</span> <span class="n">DB</span><span class="p">[</span><span class="s1">&#39;replays_info&#39;</span><span class="p">]</span>


<span class="c1"># Define the dependency the default to sc2reader</span>
<span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">replay_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s2">&quot;Invalid replay path&quot;</span>
<span class="n">REPLAY_GEN</span> <span class="o">=</span> <span class="n">sc2reader</span><span class="o">.</span><span class="n">load_replays</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">replay_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Information-Management">Information Management<a class="anchor-link" href="#Information-Management"> </a></h3><p>Fallowing a functional programming approach in the development of this project, two frozen dataclasses are defined to ensure inmutability during the process of the information; <a href="/sc2trainingg/ingest.html#Replay_data"><code>Replay_data</code></a> and <a href="/sc2trainingg/ingest.html#Player_data"><code>Player_data</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Player_data" class="doc_header"><code>class</code> <code>Player_data</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L41" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Player_data</code>(<strong><code>name</code></strong>:<code>str</code>, <strong><code>number</code></strong>:<code>int</code>, <strong><code>race</code></strong>:<code>str</code>, <strong><code>result</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Immutable dataclass that contains Information that describes a
player's attributes in a match.</p>
<p><em>Attributes:</em></p>

<pre><code>- name (str):
    The player's user name.
- number (int):
    Player number in the match. In a 1v1, match there would be a Player 1 and 2.
- race (str):
    The game race (Protoss, Terran, Zerg) with which the player played this match.
- result (str):
    Variable descriving whether the player was the matches winner ('Win') or loser ('Loss').</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Replay_data" class="doc_header"><code>class</code> <code>Replay_data</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Replay_data</code>(<strong><code>replay_name</code></strong>:<code>str</code>, <strong><code>replay_id</code></strong>:<code>str</code>, <strong><code>date_time</code></strong>:<code>datetime</code>, <strong><code>match_type</code></strong>:<code>str</code>, <strong><code>game_release</code></strong>:<code>str</code>, <strong><code>map_name</code></strong>:<code>str</code>, <strong><code>category</code></strong>:<code>str</code>, <strong><code>winner</code></strong>:<code>str</code>, <strong><code>players</code></strong>:<code>Tuple</code>[<a href="/sc2trainingg/ingest.html#Player_data"><code>Player_data</code></a>, <code>Ellipsis</code>])</p>
</blockquote>
<p>Immutable dataclass that contains information summarising a
match's main attributes.</p>
<p><em>Attributes:</em></p>

<pre><code>- replay_name (str):
    Absolute path of where the Replay was stored when uploaded.
- replay_id (str):
    Name of the SC2Replay file.
- date_time (datetime):
    Date and time when the match was played and recorded.
- match_type (str):
    Descrives the team configuration of the match (eg '1v1', '2v2').
- game_release (str):
    Version and patch number for the game release where the match
    played.
- map_name (str):
    Name of the match's map.
- category (str):
    Descrives if the match was 'Ladder' or other type of match.
- winner (str):
    User name of the match's winner
- players (Tuple[Player_data, ...]):
    Summarised information of the match's players (see Player_data
    class).</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Module's-Functions">Module's Functions<a class="anchor-link" href="#Module's-Functions"> </a></h2><p>As explained above, the module uses the functions <a href="/sc2trainingg/ingest.html#build_replay_info"><code>build_replay_info</code></a> and <a href="/sc2trainingg/ingest.html#build_reaper_collections"><code>build_reaper_collections</code></a> to construct a document-based database. Of these functions, the former is a custom function, inspired by <code>sc2reaper</code>'s information extraction and organisation processes, that selects rough information from the replay file using <code>sc2reader</code> and organises it inside the replay_info collection. The latter uses <code>sc2reaper</code> to create the rest of the data collections in the database.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Auxiliary-Functions">Auxiliary Functions<a class="anchor-link" href="#Auxiliary-Functions"> </a></h3><p>Appart from <a href="/sc2trainingg/ingest.html#build_replay_info"><code>build_replay_info</code></a> and <a href="/sc2trainingg/ingest.html#build_reaper_collections"><code>build_reaper_collections</code></a>, this modules defines a number of auxiliary functions that are used within those primary functions.</p>
<p>Here is a brief summary of those functions.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extend_player_info" class="doc_header"><code>extend_player_info</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L107" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extend_player_info</code>(<strong><code>participant</code></strong>:<code>Participant</code>)</p>
</blockquote>
<p>Extracts the players' data from a Participant Object, into a
Player_data instance.</p>
<p><em>Args:</em></p>

<pre><code>- participant (sc2reader.objects.Participant):
    Participant object containing all data related to a SC2Player

</code></pre>
<p><em>Returns:</em></p>

<pre><code>- Player_data:
    Summary of a player's attributes on a match.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_replay_info" class="doc_header"><code>get_replay_info</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L128" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_replay_info</code>(<strong><code>replay</code></strong>:<code>Replay</code>)</p>
</blockquote>
<p>Replay_data dataclass instance with a replay's general
information.</p>
<p><em>Args:</em></p>

<pre><code>- replay (sc2reader.resources.Replay):
    Replay object to be analysed.

</code></pre>
<p><em>Returns:</em></p>

<pre><code>- Replay_data
    Summary of a matches main descriptive information.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="not_replay_duplicate" class="doc_header"><code>not_replay_duplicate</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>not_replay_duplicate</code>(<strong><code>replay</code></strong>:<code>Replay</code>, <strong><code>collection_</code></strong>:<code>Collection</code>=<em><code>Collection(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=True), 'TEST_library'), 'replays_info.func')</code></em>)</p>
</blockquote>
<p>Verify that the replay does not exist in a collection.</p>
<p><em>Args:</em></p>

<pre><code>- replay (sc2reader.resources.Replay):
    The replay being cheked
- collection_ (pymongo.collection.Collection):
    The collection where the existance check is being performed.

</code></pre>
<p><em>Returns:</em></p>

<pre><code>- bool:
    True if the replay is not in the collection, False if it is.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_replays_data_set" class="doc_header"><code>get_replays_data_set</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L183" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_replays_data_set</code>(<strong><code>rp_gen</code></strong>:<code>Generator</code>, <strong><code>collection_</code></strong>:<code>Collection</code>)</p>
</blockquote>
<p>Build a generator that can yield a group of Replay_data
instances that represent a the descriptive information of a set
of replays that are found by an sc2reader replay generator
and that have not been already added to a specific collection.</p>
<p><em>Args:</em></p>

<pre><code>- rp_gen (Generator):
    a sc2reader.resources.Replay generator that yields
    the replays found in the CONFIG.replay_path.
- collection_ (pymongo.collection.Collection):
    the database collection that could contain the replays

</code></pre>
<p>Return</p>

<pre><code>- Generator:
    Yields Replay_data instances.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Main-Functions-build_replay_info-and-build_reaper_collections">Main Functions <a href="/sc2trainingg/ingest.html#build_replay_info"><code>build_replay_info</code></a> and <a href="/sc2trainingg/ingest.html#build_reaper_collections"><code>build_reaper_collections</code></a><a class="anchor-link" href="#Main-Functions-build_replay_info-and-build_reaper_collections"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="build_replay_info" class="doc_header"><code>build_replay_info</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L204" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>build_replay_info</code>(<strong><code>rp_gen</code></strong>:<code>Generator</code>=<em><code>load_all</code></em>, <strong><code>db_collection</code></strong>:<code>Collection</code>=<em><code>Collection(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=True), 'TEST_library'), 'replays_info.func')</code></em>)</p>
</blockquote>
<p>Triggers the search for new replays at CONFIG.replay_path. Adds the
information description of the replays to the a data collection within
a MongoDB data base, if they are not in the database already.</p>
<p><em>Args:</em></p>

<pre><code>- rp_gen (Generator = REPLAY_GEN):
    sc2reader.resources.Replay generator that yields the replays found
    in the CONFIG.replay_path.
- db_collection (pymongo.collection.Collection = replays_info):
    the database where the function adds the new documents.

</code></pre>
<p><em>Returns:</em></p>

<pre><code>- bool:
    True if new replays were found and added to the replay_info collection, False otherwise.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="build_reaper_collections" class="doc_header"><code>build_reaper_collections</code><a href="https://github.com/HDavidEspinosa/sc2trainingg/tree/master/sc2trainingg/ingest.py#L234" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>build_reaper_collections</code>()</p>
</blockquote>
<p>Calls the ingest function on the sc2reaper package. Make sure
you install the package from <a href="https://github.com/miguelgondu/sc2reaper">https://github.com/miguelgondu/sc2reaper</a>
in your environment before running.</p>
<p><em>Returns:</em></p>

<pre><code>- bool`:
    True if new replays were found and added to the multiple collections defined by sc2reaper, False otherwise.

</code></pre>
<p><em>Raises:</em></p>

<pre><code>- ImportError`:
    If sc2reaper is not installed in the environment.</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Execution-Example">Execution Example<a class="anchor-link" href="#Execution-Example"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">build_replay_info</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>New replay found: Jagannatha LE.SC2Replay 
 addint to replay_info collection.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">build_reaper_collections</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Found 0 replays in the database already.
Processing replay Jagannatha LE.SC2Replay
last frame recorded: 13224
last frame recorded: 13224
Successfully filled all collections of replay Jagannatha LE.SC2Replay
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

